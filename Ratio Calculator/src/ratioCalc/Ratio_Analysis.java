package ratioCalc;
import ij.IJ;
import ij.ImagePlus;
import ij.ImageStack;
import ij.WindowManager;
import ij.gui.GenericDialog;
import ij.gui.NewImage;
import ij.io.DirectoryChooser;
import ij.io.FileSaver;
import ij.io.Opener;
import ij.measure.ResultsTable;
import ij.plugin.MontageMaker;
import ij.plugin.PlugIn;
import ij.process.FloatProcessor;
import ij.process.ImageProcessor;
import ij.process.ImageStatistics;
import ij.text.TextPanel;

import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.StringTokenizer;
import java.util.Vector;

//import org.apache.commons.math3.stat.descriptive.DescriptiveStatistics;

import jsc.independentsamples.MannWhitneyTest;

// _____________________________________________________________________________________________________________
//
// --------------------
// Ratio Analysis v1.32
// --------------------
//
// Till Andlauer (till@andlauer.net)
// Date: 11-10-xx - 12-08-12
//
// Calculates various plots for data generated by Ratio Calculator. Actual plots can be generated with GnuPlot.
//
// Mann-Whitney U-test is done using the jsc.jar library from A.J. Bertie, http://www.jsc.nildram.co.uk
// It is unclear how jsc.jar handles ties.
// Because the sample sizes are clearly below 20, a normal approximatation of the U statistic is not feasible
// Yet due to the nature of the data very few ties are expected. Therefore reliable exact p-values should be calculated.
// In dubious situations the test should be repeated in a more advaned statistical program.  
//
// For statistics median values are used
// Uncertainties:
// Median Absolute Deviation    = The median of the differences of the individual values to the median              
// Standard Error of the Median = s = (a-b) / 3.4641; a = (n/2 + sqrt(3n)/n) th observation, b = (n/2 - sqrt(3n)/n) th observation, rounded up to the next number 
// Source: Lothar Sachs, Angewandte Statistik, 11. Auflage 2003, S. 160.
//
// Error propagation according to: Lothar Papula, Mathematik f√ºr Ingenieure und Naturwissenschaftler Band 3, 5. Auflage 2008, Kapitel 4.3, Seite 678ff: Gau√üsches Fehlerfortpflanzungsgesetz
// For the combination of two uncertainties x,y:     e = SQRT((x/2)^2 + (y/2)^2)
// For the combination of three uncertainties x,y,z: e = SQRT((x/3)^2 + (y/3)^2 + (z/3)^2)
//
// Current format of statistics files:
// -----------------------------------
// 1-1 Line 1: Min,Q1,Median,Q3,Max; line 2: SEMs/MADs
// 1-2 Min + SEM/MAD
// 1-3 Q1 + SEM/MAD
// 1-4 Median + SEM/MAD
// 1-5 Q3 + SEM/MAD
// 1-6 Max + SEM/MAD
// 2   Line 1: Q1 + SEM/MAD; line 2: Median + SEM/MAD; line 3: Q3 + SEM/MAD
// 3   Line 1: Min,Q1,Median,Q3,Max; line 2: SEMs/MADs; line 3: combined Min,Q1,Median,Q3,Max            
// 4   All data samples combined in one file or Mann-Whitney-U test results            
//
// Version history
// xxxxxxxxxxxxxxx
//
// v1.31
// Added support for Mann-Whitney U-tests via the jsc.jar classes (A.J. Bertie, http://www.jsc.nildram.co.uk/)
//
// v1.32 - final version used for ratio analysis
// Maintenance, compatibility adaptations, added comments, bug fixes (error propagation, normalized statistics)
// Because normalized statistics is currently disabled, this option has not been tested and might contain bugs.
//
// _____________________________________________________________________________________________________________

public class Ratio_Analysis implements PlugIn
    {   
    private String title = "Ratio Analysis v1.32";
    private String saveError = "Couldn't save file.";
    private boolean all = false; // job=3
    private boolean overview = false; // job=6
    private boolean chName = false; // for normalized statistics: use refFiles as input files
    // All of the following options can be set in chooseImages():
    private int job = 3; // type of analysis to run; 0 = Histograms, 1 = Statistics, 2 = Scatter plots, 3 = All basic plots, 4 = comparative statistics, 5 = normalized statistics (*currently disabled*), 6 = histograms overview
    private int nFiles = 8; // number of files to be opened
//    private int compGroups = 0; // option to arrange comparative statistics into groups; *currently disabled*
    private boolean sd = true; // calculate/show standard errors
    private boolean statsMean = true; // use mean instead of median for statistics
    private boolean stats_mad = false; // use MAD (median absolute deviation) for statistics
    private boolean histo_med = false; // use median for histograms
    private static boolean oldFormat = false; // read statistics files in the old format (for compatibility)
    private String plottitle = "Ratios";
    private String axislabel = "ratios";
    private String directory = "/Users/till/"; // directory for saving files manually
    private boolean screen = true; // show results on screen
    private String terminal = "aqua"; // output of data (aqua/x11/windows/wxt)
    private boolean svg = true; // create .svg file
    private boolean png = true; // create .png file
    private String[] xTitle = new String[nFiles]; // x-labels for the different files (statistics)
    private String[] refFiles = new String[3]; // files for the normalized statistics (*currently disabled*)

    public void run(String arg) 
        {   
        boolean success = fileDialog();
        if (!success) return;

        success = createFile();
        }


    private TextPanel initFile() 
        {
        TextPanel tp = new TextPanel();
        tp.append("#!/usr/local/bin/gnuplot -persist");
        tp.append("#");
        tp.append("reset");
        tp.append("set datafile missing \"-\"");
        tp.append("set key enhanced");
        return tp;
        }


    public boolean createFile() // do all calculations and create the output files
        {
        // Variables used by several jobs
        TextPanel tp; // content of the output files
        String imagename = ""; // name of the images created by the gnuplot scripts
        String filename = ""; // name of the gnuplot script
        Opener inFile = new Opener(); // for opening input Tiffs
        String inputname = ""; // name of the input file
        ImagePlus img_out; // output image
        FileSaver outFile; // for saving Tiffs

        if (job==0 || all) // histograms
            {
            // creates 3 files: the data file 00 Histogram Summary.xls with average histogram values, a gnuplot script and a montage of all histogram plots
           
            if (!overview) // if only the histogram overview should be created, skip this part
                { // merge the histograms from several files into one
                imagename = "00 Histogram";
                filename = "histoscript.plt";   
                tp = initFile(); // initialize the gnuplot script   

                if (sd) // also calculate standard errors
                    {
                    int[][] data = loadHistoFiles(); // all histogram files; [bins][files]
                    if (data==null) return false;
                    double[] means = new double[data.length]; // mean/median values of all bins
                    double[] sem = new double[data.length]; // standard errors for all means

                    for (int i=0; i<data.length; i++) // go through bins
                        {
                        if (histo_med) // use medians
                            {
                            means[i] = getMedian(data[i]);
                            sem[i] = getSEMed(data[i]); // calculate standard error of the median
                            }
                        else // use means
                            {
                            means[i] = getMean(data[i]); // average each bin
                            sem[i] = getSD(data[i], means[i])/Math.sqrt((double)data[0].length); // calculate standard error of the mean
                            }
                        }
        
                    ResultsTable rt = ResultsTable.getResultsTable(); // for the output data
                    rt.reset();
                    rt.setPrecision(9);
        
                    for (int i=0; i<means.length; i++)
                        {
                        rt.incrementCounter();
                        if (histo_med) rt.addValue("Median", means[i]);    
                        else rt.addValue("Mean", means[i]);    
                        rt.addValue("SEM", sem[i]);    
                        }
                    try
                        {
                        rt.saveAs(directory+"00 Histogram Summary.xls");    
                        }
                    catch (IOException e) 
                        {
                        IJ.error(saveError); 
                        return false;
                        } 
    
                    // create the gnuplot script
                    if (plottitle!="") tp.append("set title \""+plottitle+"\"");
                    if (axislabel!="") tp.append("set xlabel \""+axislabel+"\" offset +0,1 tc rgb \"#062356\"");
                    tp.append("set ylabel \"frequency\" offset +2,0 tc rgb \"#062356\"");
                    tp.append("set xrange [1:128]");
                    tp.append("set yrange [0:4096]");
                    tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
                    tp.append("set border 3 linestyle 10");
                    tp.append("set xtics 4 tc rgb \"#113577\" nomirror rotate by -45");
                    tp.append("set ytics 200 tc rgb \"#113577\" nomirror");
                    tp.append("set tics front out");
                    tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
                    tp.append("set style fill solid 0.9 border");
                    tp.append("set style data histogram");
                    tp.append("set bars small back");
                    if (screen) // show output
                        {
                        tp.append("set term "+terminal+" title \"Ratios\"");
                        tp.append("set multiplot");
                        tp.append("set grid back xtics ytics linestyle 11");
                        tp.append("set style histogram errorbars gap 0 lw 2");
                        tp.append("plot \'00 Histogram Summary.xls\' using 2:3 notitle lc rgb \"#808080\"");
                        tp.append("unset grid");
                        tp.append("set style histogram clustered gap 0");
                        tp.append("plot \'00 Histogram Summary.xls\' using 2 notitle lc rgb \"#164191\"");
                        tp.append("unset multiplot");
                        }
                    if (svg) // save output as .svg
                        {
                        tp.append("set term svg dynamic enhanced");
                        tp.append("set output \""+imagename+".svg\"");
                        tp.append("set multiplot");
                        tp.append("set grid back xtics ytics linestyle 11");
                        tp.append("set style histogram errorbars gap 0 lw 2");
                        tp.append("plot \'00 Histogram Summary.xls\' using 2:3 notitle lc rgb \"#808080\"");
                        tp.append("unset grid");
                        tp.append("set style histogram clustered gap 0");
                        tp.append("plot \'00 Histogram Summary.xls\' using 2 notitle lc rgb \"#164191\"");
                        tp.append("unset multiplot");
                        }
                    if (png) // save output as .png
                        {
                        tp.append("set xlabel offset 0,0");
                        tp.append("set ylabel offset 0,0");
                        tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                        tp.append("set output \""+imagename+".png\"");
                        tp.append("set multiplot");
                        tp.append("set grid back xtics ytics linestyle 11");
                        tp.append("set style histogram errorbars gap 0 lw 2");
                        tp.append("plot \'00 Histogram Summary.xls\' using 2:3 notitle lc rgb \"#808080\"");
                        tp.append("unset grid");
                        tp.append("set style histogram clustered gap 0");
                        tp.append("plot \'00 Histogram Summary.xls\' using 2 notitle lc rgb \"#164191\"");
                        tp.append("unset multiplot");
                        }
                    }
                    
                else // no standard errors
                    {
                    if (plottitle!="") tp.append("set title \""+plottitle+"\"");
                    if (axislabel!="") tp.append("set xlabel \""+axislabel+"\" offset +0,1 tc rgb \"#062356\"");
                    tp.append("set ylabel \"frequency\" offset +2,0 tc rgb \"#062356\"");
                    tp.append("set xrange [0:128]");
                    tp.append("set yrange [0:4096]");
                    tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
                    tp.append("set border 3 linestyle 10");
                    tp.append("set xtics 4 tc rgb \"#113577\" nomirror");
                    tp.append("set ytics 200 tc rgb \"#113577\" nomirror");
                    tp.append("set xtic rotate by -45 scale 0");
                    tp.append("set tics front out");
                    tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
                    tp.append("set grid back xtics ytics linestyle 11");
                    tp.append("set style fill solid 0.9 border");
                    if (screen)
                        {
                        tp.append("set term "+terminal+" title \"Ratios\"");
                        plotLine(tp); // creates the plot command
                        }
                    if (svg)
                        {
                        tp.append("set term svg dynamic enhanced");
                        tp.append("set output \""+imagename+".svg\"");
                        if (!screen) plotLine(tp);
                        else tp.append("replot");
                        }
                    if (png)
                        {
                        tp.append("set xlabel offset 0,0");
                        tp.append("set ylabel offset 0,0");
                        tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                        tp.append("set output \""+imagename+".png\"");
                        if (!screen && !svg) plotLine(tp);
                        else tp.append("replot");
                        }
                    }
    
                tp.append("#EOF"); // end gnuplot script
                tp.saveAs(directory+filename); // write script to file  
                } // end of overview=false
                 
            // make overview (montage)
            ImageStack stack = new ImageStack();
            ImagePlus imp; // temp image for the input histograms as well as the output image
            ImageProcessor ip;
            for (int i=0; i<nFiles; i++) // combine all histograms into a stack
                {
                if (i<9) inputname = "0"+(i+1)+" Histogram plot.tif";
                else inputname = (i+1)+" Histogram plot.tif";          
                imp = inFile.openTiff(directory, inputname);
                if (imp==null) return false;
                ip = imp.getProcessor(); 
                if (i==0) stack = new ImageStack(ip.getWidth(), ip.getHeight());
                stack.addSlice(null, ip); // add histogram to stack
                }
            imp = new ImagePlus("Histograms", stack); // create image for the stacks          
            MontageMaker mm = new MontageMaker(); // make a montage of the files
            if (nFiles < 6) img_out = mm.makeMontage2(imp, nFiles, 1, 0.5, 1, nFiles, 1, 1, false);
            else if (nFiles == 6) img_out = mm.makeMontage2(imp, 2, 3, 0.5, 1, nFiles, 1, 1, false);
            else if (nFiles < 11) img_out = mm.makeMontage2(imp, (int)Math.round(nFiles/2.0), 2, 0.5, 1, nFiles, 1, 1, false);
            else img_out = mm.makeMontage2(imp, (int)Math.round(nFiles/3.0), 3, 0.5, 1, nFiles, 1, 1, false);
            img_out.setTitle("Histograms");
            outFile = new FileSaver(img_out);
            outFile.saveAsTiff(directory+"00 Histograms.tif");
            } // end of job=0 (histograms)
            
        if (job==1 || all) // basic statistics
            {
            // files created:
            // 00 Statistics Summary 4.xls   - list of all original values, one line per file
            // 00 Statistics Summary 3.xls   - Line 1: Min,Q1,Median,Q3,Max; line 2: SEMs/MADs; line 3: combined Min,Q1,Median,Q3,Max            
            // 00 Statistics Summary 1-1.xls - Line 1: Min,Q1,Median,Q3,Max; line 2: SEMs/MADs
            // 00 Statistics Summary 2.xls   - Line 1: Q1 + SEM/MAD; line 2: Median + SEM/MAD; line 3: Q3 + SEM/MAD
            // 00 Statistics Summary 1-2.xls - Min + SEM/MAD (only if sd=true)
            // 00 Statistics Summary 1-3.xls - Q1 + SEM/MAD (only if sd=true)
            // 00 Statistics Summary 1-4.xls - Median + SEM/MAD (only if sd=true)
            // 00 Statistics Summary 1-5.xls - Q3 + SEM/MAD (only if sd=true)
            // 00 Statistics Summary 1-6.xls - Max + SEM/MAD (only if sd=true)
            // statscript1.plt - GnuPlot script box-whisker plot
            // statscript2.plt - GnuPlot script box plot

            // Load data
            double[][] data = loadStatFiles(1, 5, false, "", false); // read 1 line per file, 5 columns per file, don't inverse: data = [data][files], don't add a string to the input name, don't just get the median but all data
            if (data==null) return false;
            double[] median = new double[data.length];
            double[] sem = new double[data.length]; // standard error
            double[] mad = new double[data[0].length]; // used for calculating the median absolute deviation
            double[] invMed = new double[data.length]; // inverse, unifomly distributed values (see below)

            ResultsTable rt = ResultsTable.getResultsTable(); // output
            rt.reset();
            rt.setPrecision(9);
            
            // Create 00 Statistics Summary 4.xls (list of all original values)
            for (int i=0; i<data[0].length; i++) // go through all files
                {
                rt.incrementCounter();
                rt.addValue("Min", data[0][i]);    
                rt.addValue("Q1", data[1][i]);    
                rt.addValue("Med", data[2][i]);    
                rt.addValue("Q3", data[3][i]);    
                rt.addValue("Max", data[4][i]);    
                }
            try
                {
                rt.saveAs(directory+"00 Statistics Summary 4.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // Calculate median/mean values and errors/deviations
            // old format:
            // first line: combined results // second line: standard results // third line: inverted results
            // new format:
            // first line: standard results // second line: combined results // third line: inverted results
            // combined results: 
            // show the original value if 0<=value<=1, otherwise 1 + (1 - the inverted value)
            // this way values are uniformly distributed around 1
            // The original values are used for statistics (standard results, line 1)

//            DescriptiveStatistics stats = new DescriptiveStatistics();            
            
            for (int i=0; i<data.length; i++) // data[x][y]: [x]=min,q1,med,q3,max; [y]=file 
                {
            	if (statsMean)
	            	{
//            		median[i] = getMean(data[i]); // get the mean for each value (min,q1‚median,q3,max)
//            		median[i] = math3.(data[i]); // get the mean for each value (min,q1‚median,q3,max)
	            	}
            	else // median
            		{
	            	Arrays.sort(data[i]);
	                median[i] = getMedian(data[i]); // get the median for each value (min,q1‚median,q3,max)
            		}    
                if (oldFormat) // old file format, obsolete
                    {
                    if (median[i]>1) invMed[i] = 1.0d/(2-median[i]);
                    else invMed[i] = median[i];
                    }
                else
                    {
                    if (median[i]>1) invMed[i] = 1+(1-(1.0d/median[i]));
                    else invMed[i] = median[i];
                    }

                if (stats_mad)
                    {
                    for (int j=0; j<data[0].length; j++) // calc median absolute deviation (mad)
                        {
                        if (oldFormat) mad[j] = Math.abs(invMed[i]-1.0d/(2-data[i][j]));
                        else mad[j] = Math.abs(median[i]-data[i][j]); // the difference between the individual values in each file and the median
                        }
                    Arrays.sort(mad);
                    sem[i] = getMedian(mad); // mad = the median of the differences of the individual values to the median              
                    }
                else
                    {
                    sem[i] = getSEMed(data[i]); // get standard error of the median                      
                    }
                } // from now on the sequences of the values are different from the original files (each column has been sorted individually)

            // Create 00 Statistics Summary 3.xls (Standard results, uncertainties, combined results)
            rt = ResultsTable.getResultsTable(); 
            rt.reset();

            rt.incrementCounter();
            rt.addValue("Min", median[0]);    
            rt.addValue("Q1", median[1]);    
            rt.addValue("Med", median[2]);    
            rt.addValue("Q3", median[3]);    
            rt.addValue("Max", median[4]);    
            rt.incrementCounter();
            rt.addValue("Min", sem[0]);    
            rt.addValue("Q1", sem[1]);    
            rt.addValue("Med", sem[2]);    
            rt.addValue("Q3", sem[3]);    
            rt.addValue("Max", sem[4]);    
            rt.incrementCounter();
            rt.addValue("Min", invMed[0]);    
            rt.addValue("Q1", invMed[1]);    
            rt.addValue("Med", invMed[2]);    
            rt.addValue("Q3", invMed[3]);    
            rt.addValue("Max", invMed[4]);    

            try
                {
                rt.saveAs(directory+"00 Statistics Summary 3.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // 00 Statistics Summary 1-1.xls - Line 1: Min,Q1,Median,Q3,Max; line 2: SEMs/MADs
            rt.reset();
            if (oldFormat)
                {
                rt.incrementCounter();
                rt.addValue("Min", invMed[0]);    
                rt.addValue("Q1", invMed[1]);    
                rt.addValue("Med", invMed[2]);    
                rt.addValue("Q3", invMed[3]);    
                rt.addValue("Max", invMed[4]);    
                }
            else
                {
                rt.incrementCounter();
                rt.addValue("Min", median[0]);    
                rt.addValue("Q1", median[1]);    
                rt.addValue("Med", median[2]);    
                rt.addValue("Q3", median[3]);    
                rt.addValue("Max", median[4]);    
                }
            rt.incrementCounter();
            rt.addValue("Min", sem[0]);    
            rt.addValue("Q1", sem[1]);    
            rt.addValue("Med", sem[2]);    
            rt.addValue("Q3", sem[3]);    
            rt.addValue("Max", sem[4]);    

            try
                {
                rt.saveAs(directory+"00 Statistics Summary 1-1.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // 00 Statistics Summary 2.xls - Line 1: Q1 + SEM/MAD; line 2: Median + SEM/MAD; line 3: Q3 + SEM/MAD
            rt.reset();
            for (int i=1; i<median.length-1; i++)
                {
                rt.incrementCounter();
                if (oldFormat) rt.addValue("Median", invMed[i]);    
                else rt.addValue("Median", median[i]);    
                if (stats_mad) rt.addValue("MAD", sem[i]);
                else rt.addValue("SEM", sem[i]);
                }
            try
                {
                rt.saveAs(directory+"00 Statistics Summary 2.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // 00 Statistics Summary 1-2 - 1-6.xls - results + SEM/MAD
            if (sd) // only if SEM/MAD should be plotted
                {            
                for (int i=0; i<median.length; i++)
                    {
                    rt.reset();
                    rt.incrementCounter();
                    if (oldFormat) rt.addValue("Median", invMed[i]);    
                    else rt.addValue("Median", median[i]);    
                    if (stats_mad) rt.addValue("MAD", sem[i]);
                    else rt.addValue("SEM", sem[i]);
                    try
                        {
                        rt.saveAs(directory+"00 Statistics Summary 1-"+(i+2)+".xls");    
                        }
                    catch (IOException e) 
                        {
                        IJ.error(saveError); 
                        return false;
                        } 
                    }
                }

            // create gnuplot script 1: box-whisker plot
            imagename = "00 Statistics 1";
            filename = "statscript1.plt";

            tp = initFile(); // initialize the gnuplot script
            if (plottitle!="") tp.append("set title \""+plottitle+"\"");
            tp.append("set xlabel \"\" ");
            tp.append("set ylabel \"ratio\" offset +2,0 tc rgb \"#062356\"");
            tp.append("set xrange [0:2]");
            tp.append("set yrange [0.00390625:256]");
            tp.append("set logscale y 2");
            tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
            tp.append("set border 3 linestyle 10");
            tp.append("set ytics (\"1/256\" 0.00390625, \"1/128\" 0.0078125, \"1/64\" 0.015625, \"1/32\" 0.03125, \"1/16\" 0.0625, \"1/8\" 0.125, \"1/4\" 0.25, \"1/2\" 0.5, \"1/1\" 1, \"2/1\" 2, \"4/1\" 4, \"8/1\" 8, \"16/1\" 16, \"32/1\" 32, \"64/1\" 64, \"128/1\" 128, \"256/1\" 256) tc rgb \"#113577\" nomirror");
            tp.append("set tics front out");
            tp.append("unset xtics");
            tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
            tp.append("set style fill solid 0.9 border");
            tp.append("set boxwidth 1.0");
            tp.append("set bars small");

            if (sd) // add error bars
                {
                if (screen)
                    {
                    tp.append("set term "+terminal+" title \"Ratios\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("unset multiplot");
                    }
                if (svg)
                    {
                    tp.append("set term svg dynamic enhanced");
                    tp.append("set output \""+imagename+".svg\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("unset multiplot");
                    }
                if (png)
                    {
                    tp.append("set xlabel offset 0,0");
                    tp.append("set ylabel offset 0,0");
                    tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                    tp.append("set output \""+imagename+".png\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("unset multiplot");
                    }
                }
            else // no error bars
                {
                if (screen)
                    {
                    tp.append("set term "+terminal+" title \"Ratios\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 4 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 5 lc rgb \"#1F497D\" notitle");
                    tp.append("unset multiplot");
                    }
                if (svg)
                    {
                    tp.append("set term svg dynamic enhanced");
                    tp.append("set output \""+imagename+".svg\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 4 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 5 lc rgb \"#1F497D\" notitle");
                    tp.append("unset multiplot");
                    }
                if (png)
                    {
                    tp.append("set xlabel offset 0,0");
                    tp.append("set ylabel offset 0,0");
                    tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                    tp.append("set output \""+imagename+".png\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 4 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 5 lc rgb \"#1F497D\" notitle");
                    tp.append("unset multiplot");
                    }
                }

            tp.append("#EOF");
            tp.saveAs(directory+filename); // end of statscript1.plt

            // create gnuplot script 2: box plot
            imagename = "00 Statistics 2";
            filename = "statscript2.plt";
            tp = initFile(); // initialize the gnuplot script

            if (plottitle!="") tp.append("set title \""+plottitle+"\"");
            tp.append("set xlabel tc rgb \"#062356\"");
            tp.append("set ylabel \"ratio\" offset +2,0 tc rgb \"#062356\"");
            tp.append("set xrange [0:4]");
/*            double yLow = 0.5; // automatic generation of yrange
            double yHigh = 2.0;
            tp.append("set yrange ["+IJ.d2s(yLow,1)+":"+IJ.d2s(yHigh,1)+"]"); */
            tp.append("set yrange [0.00390625:256]");
            tp.append("set logscale y 2");
            tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
            tp.append("set border 3 linestyle 10");
            tp.append("set xtics (\"\" 0, \"Quartile 1\" 1, \"Median\" 2, \"Quartile 3\" 3, \"\" 4) tc rgb \"#113577\" nomirror");
            tp.append("set ytics tc rgb \"#113577\" nomirror");
/*            String tics = IJ.d2s(yLow,1); // automatic generation of ytics
            long yMax = Math.round((yHigh-yLow)*10);
            for (long i=0; i<yMax; i++)
                {
                yLow = yLow + 0.1;
                tics = tics+","+yLow;
                }
            tp.append("set ytics ("+tics+") tc rgb \"#113577\" nomirror"); */
            tp.append("set tics front out");
            tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
            tp.append("set style fill solid 0.9 border");
            tp.append("set boxwidth 0.9");
            tp.append("set bars fullwidth");

            if (screen)
                {
                tp.append("set term "+terminal+" title \"Ratios\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::1::1 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::2::2 with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::3::3 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                tp.append("unset multiplot");
                }
            if (svg)
                {
                tp.append("set term svg dynamic enhanced");
                tp.append("set output \""+imagename+".svg\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::1::1 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::2::2 with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::3::3 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                tp.append("unset multiplot");
                }
            if (png)
                {
                tp.append("set xlabel offset 0,0");
                tp.append("set ylabel offset 0,0");
                tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                tp.append("set output \""+imagename+".png\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::1::1 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::2::2 with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::3::3 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                tp.append("unset multiplot");
                }
            tp.append("#EOF");
            tp.saveAs(directory+filename); // end of statscipt2.plt                  
            } // end of job 1 (statistics)
        
        if (job == 2 || all) // combines all scatter plots into one scatter plot
            {
            // 3 files: combined scatter plot tiff, text data file and gnuplot script
            ImagePlus[] img = new ImagePlus[nFiles];
            for (int i=0; i<nFiles; i++)
                {
                if (i<9) inputname = "0"+(i+1)+" Scatter plot.tif";
                else inputname = (i+1)+" Scatter plot.tif";          
                img[i] = inFile.openTiff(directory, inputname); 
                if (img[i]==null) return false;
                }
            img_out = averagePlots(img); // create the combined scatter plot
            if (img_out == null) return false;
            if (screen) img_out.show();
            outFile = new FileSaver(img_out);
            outFile.saveAsTiff(directory+"00 Scatter plot.tif");
            ImageProcessor ip = img_out.getProcessor();
            ip.flipVertical();           
            outFile.saveAsText(directory+"00 Scatter plot.txt"); // save the image data also as text file for the gnuplot script

            imagename = "00 Scatter plot";
            filename = "scatterscript.plt";
            tp = initFile(); // initialize the gnuplot script

            if (plottitle!="") tp.append("set title \""+plottitle+"\"");
            tp.append("set xlabel \"x\" offset +0,1 tc rgb \"#062356\"");
            tp.append("set ylabel \"y\" offset +3,1 tc rgb \"#062356\"");
            tp.append("set zlabel \"frequency\" offset +3,2 tc rgb \"#062356\"");
            tp.append("set zlabel rotate by +90");
            tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
            tp.append("set border 3 linestyle 10");
            tp.append("set xtics 20 tc rgb \"#113577\" nomirror rotate by +45");
            tp.append("set ytics 20 tc rgb \"#113577\" nomirror rotate by -45 offset -2,0");
            tp.append("set ztics 5000 tc rgb \"#113577\" nomirror rotate by +45 offset +1,0");
            tp.append("set cbtics 5000 tc rgb \"#113577\" nomirror");
            tp.append("set tics front out");
            tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
            tp.append("set grid xtics ytics ztics linestyle 11");
            tp.append("set ticslevel 0");
            tp.append("set xrange [0:255]");
            tp.append("set yrange [0:255]");
            tp.append("set zrange [0:65535]");
            tp.append("set cbrange [0:65535]");
            tp.append("set view 45, 135, 1, 1");
            tp.append("set isosample 100, 100");
            tp.append("set hidden3d");
            tp.append("set pm3d");
            tp.append("set palette defined (0 \"cyan\", 10921 \"blue\", 21842 \"magenta\", 32764 \"black\", 43689 \"green\", 54613 \"yellow\", 65535 \"red\")");

            if (screen)
                {
                tp.append("set term "+terminal+" title \"Scatter plot\"");
                tp.append("splot \'00 Scatter plot.txt\' matrix with lines notitle");
                }
            if (png) // .svg doesn't make sense here
                {
                tp.append("set ytics 20 tc rgb \"#113577\" nomirror rotate by -45 offset -3,0");
                tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                tp.append("set output \""+imagename+".png\"");
                if (screen) tp.append("replot");
                else tp.append("splot \'00 Scatter plot.txt\' matrix with lines notitle");
                }

            tp.append("#EOF");
            tp.saveAs(directory+filename);    
            } // end of job=3 (scatter plot)

        if (job==4) // Comparative statistics, i.e. compare several situations
            {
            // files created:
            // 00 Statistics Summary 1-1.xls - list of data from all files, one file per line: Min,Q1,Median,Q3,Max
            // 00 Statistics Summary 3.xls   - list of data from all files, three lines per file (arranged in groups): Min,Q1,Median,Q3,Max. 1st group: Standard results, 2nd group: SEM/MADs, 3rd group: Combined results. Groups are separated by "0"s
            // 00 Statistics Summary 2.xls   - list of data from all files, three lines per file: Value, SEM/MAD. 1st line: Quartile 1, 2nd line: Median, 3rd line: Quartile 3. Groups are separated by "0"s
            // 00 Statistics Summary 1-2.xls - list of data from all files, one line per file: Min, SEM/MAD (only if sd=true)
            // 00 Statistics Summary 1-3.xls - list of data from all files, one line per file: Q1, SEM/MAD (only if sd=true)
            // 00 Statistics Summary 1-4.xls - list of data from all files, one line per file: Med, SEM/MAD (only if sd=true)
            // 00 Statistics Summary 1-5.xls - list of data from all files, one line per file: Q3, SEM/MAD (only if sd=true)
            // 00 Statistics Summary 1-6.xls - list of data from all files, one line per file: Max, SEM/MAD (only if sd=true)
            // 00 Statistics Summary 4.xls - Statistical tests based on 'XX Statistics Summary 4.xls' files
            // statscript1.plt - GnuPlot script box-whisker plot
            // statscript2.plt - GnuPlot script box plot
            // statscript3.plt - GnuPlot script box-whisker plot without min/max

            // create 00 Statistics Summary 1-1.xls - list of data from all files, one file per line: Min,Q1,Median,Q3,Max
            // read and combine data from all 'XX Statistics Summary 1-1.xls' files
            double[][] data = loadStatFiles(1, 5, true, " Summary 1-1", false); // read 1 line per file, 5 columns per file, inverse format: data = [files][data], add " Summary 1-1" to the input name, don't just get the median but all data
            if (data==null) return false;

            ResultsTable rt = ResultsTable.getResultsTable(); 
            rt.reset();
            rt.setPrecision(9);
                       
            for (int i=0; i<data.length; i++)
                {
                rt.incrementCounter();
                rt.addValue("Min", data[i][0]);    
                rt.addValue("Q1", data[i][1]);    
                rt.addValue("Med", data[i][2]);    
                rt.addValue("Q3", data[i][3]);    
                rt.addValue("Max", data[i][4]);    
                }

            try
                {
                rt.saveAs(directory+"00 Statistics Summary 1-1.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 
            int c = data[0].length; // needed later for 00 Statistics Summary 1-2 - 1-6.xls

            // create 00 Statistics Summary 3.xls - list of data from all files, three lines per file (arranged in groups): Min,Q1,Median,Q3,Max. 1st group: Standard results, 2nd group: SEM/MADs, 3rd group: Combined results. Groups are separated by "0"s
            // read and combine data from all 'XX Statistics Summary 3.xls' files
            data = loadStatFiles(3, 5, true, " Summary 3", false); // read 3 lines per file, 5 columns per file, inverse format: data = [files][data], add " Summary 3" to the input name, don't just get the median but all data
            if (data==null) return false;
            rt.reset();
                       
            for (int j=0; j<data[0].length; j+=5)
                {
                for (int l=0; l<nFiles; l++)
                    {
                    rt.incrementCounter();
                    rt.addValue("Min", data[l][j]);    
                    rt.addValue("Q1", data[l][j+1]);    
                    rt.addValue("Med", data[l][j+2]);    
                    rt.addValue("Q3", data[l][j+3]);    
                    rt.addValue("Max", data[l][j+4]);    
                    }
                rt.incrementCounter(); // add a line of "0"s in between groups
                rt.addValue("Min", 0);    
                rt.addValue("Q1", 0);    
                rt.addValue("Med", 0);    
                rt.addValue("Q3", 0);    
                rt.addValue("Max", 0);    
                }

            try
                {
                rt.saveAs(directory+"00 Statistics Summary 3.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // create 00 Statistics Summary 2.xls - list of data from all files, three lines per file: Value, SEM/MAD. 1st line: Quartile 1, 2nd line: Median, 3rd line: Quartile 3. Groups are separated by "0"s
            // read and combine data from all 'XX Statistics Summary 2.xls' files
            data = loadStatFiles(3, 2, true, " Summary 2", false); // read 3 lines per file, 2 columns per file, inverse format: data = [files][data], add " Summary 2" to the input name, don't just get the median but all data
            if (data==null) return false;
            rt.reset();

            for (int j=0; j<data[0].length; j+=2)
                {
                for (int l=0; l<nFiles; l++)
                    {
                    rt.incrementCounter();
                    rt.addValue("Median", data[l][j]);    
                    rt.addValue("SEM/MAD", data[l][j+1]);
                    }
                rt.incrementCounter(); // add a line of "0"s in between groups
                rt.addValue("Median", 0);    
                rt.addValue("SEM/MAD", 0);
                }

            try
                {
                rt.saveAs(directory+"00 Statistics Summary 2.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // create 00 Statistics Summary 1-2 - 1-6.xls - list of data from all files, one line per file: Value, SEM/MAD
            if (sd) // only if uncertainties shall be calculated/plotted
                {            
                for (int i=0; i<c; i++) // do this for as many values as exist in 00 Statistics Summary 1-1.xls
                    {
                    data = loadStatFiles(1, 2, true, " Summary 1-"+(i+2)+"", false); // read 1 line per file, 2 columns per file, inverse format: data = [files][data], add " Summary 1-(i+2)" to the input name, don't just get the median but all data
                    if (data==null) return false;
                    rt.reset();
                    for (int j=0; j<data.length; j++)
                        {
                        rt.incrementCounter();
                        rt.addValue("Median", data[j][0]);    
                        rt.addValue("SEM/MAD", data[j][1]);    
                        }
                    try
                        {
                        rt.saveAs(directory+"00 Statistics Summary 1-"+(i+2)+".xls");    
                        }
                    catch (IOException e) 
                        {
                        IJ.error(saveError); 
                        return false;
                        } 
                    }
                }

            // create 00 Statistics Summary 4.xls - Statistical tests based on 'XX Statistics Summary 4.xls' files
            // the use of ArrayLists is necessary because the different files can contain different amounts of samples
            ArrayList<ArrayList<Double>> dList = loadStatList(" Summary 4"); // read 'XX Statistics Summary 4.xls' files 
            if (dList==null) return false;
            boolean success = statTest(dList); // do statistical tests and write the file
            if (!success) return false;

            // create gnuplot script 1: box-whisker plot
            imagename = "00 Statistics 1";
            filename = "statscript1.plt";
            tp = initFile(); // initialize the gnuplot script

            String xLabel =""; // create the labels for the x-axis
            for (int i=0; i<(nFiles-1); i++)
                {
                xLabel += "\""+xTitle[i]+"\" "+(i+1)+", ";
                }
            xLabel += "\""+xTitle[(nFiles-1)]+"\" "+nFiles;

            if (plottitle!="") tp.append("set title \""+plottitle+"\"");
            tp.append("set xlabel \"\" ");
            tp.append("set ylabel \"ratio\" offset +2,0 tc rgb \"#062356\"");
            tp.append("set xrange [0:"+(nFiles+1)+"]");
            tp.append("set yrange [0.00390625:256]");
            tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
            tp.append("set border 3 linestyle 10");
            tp.append("set xtics ("+xLabel+") tc rgb \"#113577\" nomirror");
            tp.append("set ytics (\"1/256\" 0.00390625, \"1/128\" 0.0078125, \"1/64\" 0.015625, \"1/32\" 0.03125, \"1/16\" 0.0625, \"1/8\" 0.125, \"1/4\" 0.25, \"1/2\" 0.5, \"1/1\" 1, \"2/1\" 2, \"4/1\" 4, \"8/1\" 8, \"16/1\" 16, \"32/1\" 32, \"64/1\" 64, \"128/1\" 128, \"256/1\" 256) tc rgb \"#113577\" nomirror");
            tp.append("set logscale y 2");
            tp.append("set tics front out");
            tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
            tp.append("set style fill solid 0.9 border");
            tp.append("set boxwidth 0.8");
            tp.append("set bars small");

            if (sd) // add error bars
                {
                if (screen) // display results
                    {
                    tp.append("set term "+terminal+" title \"Ratios\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("unset multiplot");
                    }
                if (svg) // create .svg file
                    {
                    tp.append("set term svg dynamic enhanced");
                    tp.append("set output \""+imagename+".svg\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("unset multiplot");
                    }
                if (png) // create .png file
                    {
                    tp.append("set xlabel offset 0,0");
                    tp.append("set ylabel offset 0,0");
                    tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                    tp.append("set output \""+imagename+".png\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                    tp.append("unset multiplot");
                    }
                }
            else // no error bars
                {
                if (screen)
                    {
                    tp.append("set term "+terminal+" title \"Ratios\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("unset multiplot");
                    }
                if (svg)
                    {
                    tp.append("set term svg dynamic enhanced");
                    tp.append("set output \""+imagename+".svg\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("unset multiplot");
                    }
                if (png)
                    {
                    tp.append("set xlabel offset 0,0");
                    tp.append("set ylabel offset 0,0");
                    tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                    tp.append("set output \""+imagename+".png\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                    tp.append("unset multiplot");
                    }
                }

            tp.append("#EOF");
            tp.saveAs(directory+filename); // end of statscript1.plt   

            // create gnuplot script 2: box plot
            imagename = "00 Statistics 2";
            filename = "statscript2.plt";
            tp = initFile(); // initialize the gnuplot script

            c = 1; // create the labels for the x-axis
            xLabel = "";
            for (int j=0; j<3; j++)
                {
                for (int i=0; i<nFiles; i++)
                    {
                    if (j==2 && i==(nFiles-1)) xLabel += "\""+xTitle[i]+"\" "+c;
                    else xLabel += "\""+xTitle[i]+"\" "+c+", ";
                    c++;
                    }
                c++;
                }

            if (plottitle!="") tp.append("set title \""+plottitle+"\"");
            tp.append("set xlabel tc rgb \"#062356\"");
            tp.append("set ylabel \"ratio\" offset +2,0 tc rgb \"#062356\"");
            tp.append("set label 1 \"Quartile 1\" at graph 0.167,-0.08 center tc rgb \"#062356\"");
            tp.append("set label 2 \"Median\" at graph 0.5,-0.08 center tc rgb \"#062356\"");
            tp.append("set label 3 \"Quartile 3\" at graph 0.833,-0.08 center tc rgb \"#062356\"");
            tp.append("set xrange [0:"+((nFiles*3)+3)+"]");
/*            double yLow = 0.5; // automatic generation of y-range
            double yHigh = 2.0;
            tp.append("set yrange ["+IJ.d2s(yLow,1)+":"+IJ.d2s(yHigh,1)+"]");*/
            tp.append("set yrange [0.00390625:256]");
            tp.append("set logscale y 2");
            tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
            tp.append("set border 3 linestyle 10");
            tp.append("set ytics tc rgb \"#113577\" nomirror");
/*            String tics = IJ.d2s(yLow,1); // automatic generation of y-tics
            long yMax = Math.round((yHigh-yLow)*10);
            for (long i=0; i<yMax; i++)
                {
                if (yLow<=2) yLow = yLow + 0.1;
                else 
                    {
                    yLow = yLow + 0.2;
                    i++;
                    }
                tics = tics+","+yLow;
                }
            tp.append("set ytics ("+tics+") tc rgb \"#113577\" nomirror");*/
            tp.append("set xtics ("+xLabel+") tc rgb \"#113577\" nomirror offset 0,0.5");
            tp.append("set tics front out");
            tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
            tp.append("set style fill solid 0.9 border");
            tp.append("set boxwidth 0.9");
            tp.append("set bars small back");

            if (screen)
                {
                tp.append("set term "+terminal+" title \"Ratios\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::1::"+nFiles+" with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::"+(nFiles+2)+"::"+((nFiles+2)+nFiles)+" with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::"+((nFiles*2)+3)+"::"+((nFiles*2)+3+nFiles)+" with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                tp.append("unset multiplot");
                }
            if (svg)
                {
                tp.append("set term svg dynamic enhanced");
                tp.append("set output \""+imagename+".svg\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::1::"+nFiles+" with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::"+(nFiles+2)+"::"+((nFiles+2)+nFiles)+" with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::"+((nFiles*2)+3)+"::"+((nFiles*2)+3+nFiles)+" with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                tp.append("unset multiplot");
                }
            if (png)
                {
                tp.append("set xlabel offset 0,0");
                tp.append("set ylabel offset 0,0");
                tp.append("set label 1 at graph 0.167,-0.035 center");
                tp.append("set label 2 at graph 0.5,-0.035 center");
                tp.append("set label 3 at graph 0.833,-0.035 center");
                tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                tp.append("set output \""+imagename+".png\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::1::"+nFiles+" with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::"+(nFiles+2)+"::"+((nFiles+2)+nFiles)+" with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2 every ::"+((nFiles*2)+3)+"::"+((nFiles*2)+3+nFiles)+" with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2:3 every ::1::"+nFiles+" with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2:3 every ::"+(nFiles+2)+"::"+((nFiles+2)+nFiles-1)+" with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                tp.append("plot \'00 Statistics Summary 2.xls\' using 1:2:3 every ::"+((nFiles*2)+3)+"::"+((nFiles*2)+3+nFiles-1)+" with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                tp.append("unset multiplot");
                }
            tp.append("#EOF");
            tp.saveAs(directory+filename); // end of statscript2.plt                    

            // create gnuplot script 3: box-whisker plot without min/max
            imagename = "00 Statistics 3";
            filename = "statscript3.plt";
            tp = initFile(); // initialize the gnuplot script

            if (plottitle!="") tp.append("set title \""+plottitle+"\"");
            tp.append("set xlabel \"\" ");
            tp.append("set ylabel \"ratio\" offset +2,0 tc rgb \"#062356\"");
            tp.append("set xrange [0:"+(nFiles+1)+"]");
            tp.append("set yrange [0.00390625:256]");
            tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
            tp.append("set border 3 linestyle 10");
            tp.append("set xtics ("+xLabel+") tc rgb \"#113577\" nomirror");
            tp.append("set ytics (\"1/256\" 0.00390625, \"1/128\" 0.0078125, \"1/64\" 0.015625, \"1/32\" 0.03125, \"1/16\" 0.0625, \"1/8\" 0.125, \"1/4\" 0.25, \"1/2\" 0.5, \"1/1\" 1, \"2/1\" 2, \"4/1\" 4, \"8/1\" 8, \"16/1\" 16, \"32/1\" 32, \"64/1\" 64, \"128/1\" 128, \"256/1\" 256) tc rgb \"#113577\" nomirror");
            tp.append("set logscale y 2");
            tp.append("set tics front out");
            tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
            tp.append("set style fill solid 0.9 border");
            tp.append("set boxwidth 0.8");
            tp.append("set bars small");

            if (screen)
                {
                tp.append("set term "+terminal+" title \"Ratios\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("unset multiplot");
                }
            if (svg)
                {
                tp.append("set term svg dynamic enhanced");
                tp.append("set output \""+imagename+".svg\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("unset multiplot");
                }
            if (png)
                {
                tp.append("set xlabel offset 0,0");
                tp.append("set ylabel offset 0,0");
                tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                tp.append("set output \""+imagename+".png\"");
                tp.append("set multiplot");
                tp.append("set grid back ytics linestyle 11");
                tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                tp.append("unset grid");
                tp.append("plot \'00 Statistics Summary 1-1.xls\' using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                tp.append("plot \'00 Statistics Summary 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("plot \'00 Statistics Summary 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("plot \'00 Statistics Summary 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#800080\" notitle");
                tp.append("unset multiplot");
                }

            tp.append("#EOF");
            tp.saveAs(directory+filename); // end of statscript3.plt     
            } // end of job 4, comparative statistics
        
        if (job == 5) // normalized statistics (currently disabled and therefore not completely tested/supported)
            {
            // normalize a first set of files to a reference; normalize a second set of files to the normalized first set of files.
            // EXAMPLE: reference: ratios within a neuropile of wildtype brains. 
            // first set: ratios within the same neuropile, yet from a different group of brains (e.g. with GAL4-GFP expression). 
            // second set: masked subset of ratios (positive for GFP) within that neuropile, in the same brains as the first set.   

            // files created:
            // 2x 00 Statistics Summary XXX 3.xls   - Min,Q1,Median,Q3,Max. 1st line: Standard results, 2nd line: SEM/MADs, 3rd line: Combined results
            // 2x 00 Statistics Summary XXX 1-1.xls - Min,Q1,Median,Q3,Max. 1st line: Standard results, 2nd line: SEM/MADs
            // 2x 00 Statistics Summary XXX 2.xls   - Value, SEM/MAD. 1st line: Quartile 1, 2nd line: Median, 3rd line: Quartile 3. 
            // 2x 00 Statistics Summary XXX 1-2.xls - Min, SEM/MAD
            // 2x 00 Statistics Summary XXX 1-3.xls - Q1, SEM/MAD
            // 2x 00 Statistics Summary XXX 1-4.xls - Med, SEM/MAD
            // 2x 00 Statistics Summary XXX 1-5.xls - Q3, SEM/MAD
            // 2x 00 Statistics Summary XXX 1-6.xls - Max, SEM/MAD
            // 2x statscript1_XXX.plt - GnuPlot script box-whisker plot
            // 2x statscript2_XXX.plt - GnuPlot script box plot
            
            // read all data
            String dirTemp = directory;
            directory = dirTemp+refFiles[1]+"/"; // get the first set (complete neuropile)          
            double[][] neuropil = loadStatFiles(1, 5, false, "", false); // read 1 line per file, 5 columns per file, don't use inverse format: data = [data][files], don't add a string to the input name, don't just get the median but all data
            if (neuropil==null) return false;
            directory = dirTemp+refFiles[2]+"/"; // get the second set (positive for GFP)           
            double[][] signal = loadStatFiles(1, 5, false, "", false); // read 1 line per file, 5 columns per file, don't use inverse format: data = [data][files], don't add a string to the input name, don't just get the median but all data
            if (signal==null) return false;
            directory = dirTemp;
            int filesTemp = nFiles; // temporarily read just 1 file for the reference
            nFiles = 1;
            chName = true; // change the name to the name of the reference files (needed within loadStatFiles())
            double[][] reference =  loadStatFiles(2, 5, false, "", false); // read 2 lines per file, 5 columns per file, don't use inverse format: data = [data][files], don't add a string to the input name, don't just get the median but all data
            if (reference==null) return false;
            nFiles = filesTemp;
            chName = false;
            double[][] corrN = new double[neuropil.length][neuropil[0].length]; // for normalization factors, neuropile, first set, '‚Ä¶N[]')
            double[][] corrS = new double[neuropil.length][neuropil[0].length]; // for final values, signal, second set, '‚Ä¶S[]')

            // normalize
            for (int i=0; i<neuropil.length; i++)
                {
                for (int j=0; j<neuropil[0].length; j++)
                    {
                    corrN[i][j] = neuropil[i][j]/reference[i][0]; // normalize the first set by the reference
                    corrS[i][j] = signal[i][j]/corrN[i][j]; // normalize the second set by the normalized first set
                    }
                }

            // Calculate median/mean values and errors/deviations
            // old format:
            // first line: combined results // second line: standard results // third line: inverted results
            // new format:
            // first line: standard results // second line: combined results // third line: inverted results
            // combined results: 
            // show the original value if 0<=value<=1, otherwise 1 + (1 - the inverted value)
            // this way values are uniformly distributed around 1
            // The original values are used for statistics (standard results, line 1)
            double[] medianN = new double[neuropil.length]; // create arrays for all subsequent calculations
            double[] semN = new double[neuropil.length];
            double[] medianS = new double[neuropil.length];
            double[] semS = new double[neuropil.length];
            double[] madN = new double[neuropil[0].length];
            double[] madS = new double[neuropil[0].length];
            double[] invMedN = new double[neuropil.length];
            double[] invMedS = new double[neuropil.length];

            for (int i=0; i<neuropil.length; i++)
                {
                Arrays.sort(corrN[i]);
                medianN[i] = getMedian(corrN[i]); // median
                Arrays.sort(corrS[i]);
                medianS[i] = getMedian(corrS[i]);
                
                if (stats_mad) // use MAD
                    {
                    for (int j=0; j<neuropil[0].length; j++) // calc median absolute deviation (mad)
                        {
                        if (oldFormat)
                            {
                            madN[j] = Math.abs(1.0d/(2-medianN[i])-1.0d/(2-corrN[i][j]));
                            madS[j] = Math.abs(1.0d/(2-medianS[i])-1.0d/(2-corrS[i][j]));
                            }
                        else
                            {
                            madN[j] = Math.abs(medianN[i]-corrN[i][j]); // the difference between the individual values in each file and the median
                            madS[j] = Math.abs(medianS[i]-corrS[i][j]);
                            }
                        }
                    Arrays.sort(madN);
                    semN[i] = getMedian(madN);               
                    Arrays.sort(madS);
                    semS[i] = getMedian(madS);               
                    }
                else // use standard error of the median
                    {
                    semN[i] = getSEMed(corrN[i]); // get standard error of the median                      
                    semS[i] = getSEMed(corrS[i]); // get standard error of the median                      
                    }

                if (oldFormat) // old file format, obsolete
                    {
                    if (medianS[i]<((1.0d/255.0d)/4.0d)) medianS[i]=(1.0d/255.0d)/4.0d; // catch min value
                    else if (medianS[i]>2.0d) medianS[i]=2.0d; // catch max value               

                    if (medianN[i]>=2) invMedN[i] = 255;
                    else if (medianN[i]>1) invMedN[i] = 1.0d/(2-medianN[i]);
                    else invMedN[i] = medianN[i];
                    if (medianS[i]>=2) invMedS[i] = 255;
                    else if (medianS[i]>1) invMedS[i] = 1.0d/(2-medianS[i]);
                    else invMedS[i] = medianS[i];
                    }
                else
                    {
                    if (medianS[i]<((1.0d/255.0d)/4.0d)) medianS[i]=(1.0d/255.0d)/4.0d; // catch min value
                    else if (medianS[i]>255.0d*4.0d) medianS[i]=255.0d*4.0d; // catch max value               

                    if (medianN[i]>=2) invMedN[i] = 255;
                    else if (medianN[i]>1) invMedN[i] = 1+(1-(1.0d/medianN[i]));
                    else invMedN[i] = medianN[i];
                    if (medianS[i]>=2) invMedS[i] = 255;
                    else if (medianS[i]>1) invMedS[i] = 1+(1-(1.0d/medianS[i]));
                    else invMedS[i] = medianS[i];
                    }
                }

            // create 2x 00 Statistics Summary [refFiles] 3.xls - Min,Q1,Median,Q3,Max. 1st line: Standard results, 2nd line: SEM/MADs, 3rd line: Combined results
            ResultsTable rt = ResultsTable.getResultsTable(); // final normalized values (signal, second set, '‚Ä¶S[]')
            rt.reset();
            rt.setPrecision(9);
            ResultsTable rt2 = new ResultsTable(); // normalization factors (neuropile, first set, '‚Ä¶N[]') 
            rt2.reset();
            rt2.setPrecision(9);

            // calculate final uncertainties
            // NOTE: error propagation according to: Lothar Papula, Mathematik f√ºr Ingenieure und Naturwissenschaftler Band 3, 5. Auflage 2008. Kapitel 4.3, Seite 678ff: Gau√üsches Fehlerfortpflanzungsgesetz
            // for the combination of two uncertainties x,y:     e = SQRT((x/2)^2 + (y/2)^2)
            // for the combination of three uncertainties x,y,z: e = SQRT((x/3)^2 + (y/3)^2 + (z/3)^2)
            double[] finalSemN = new double[neuropil.length];
            double[] finalSemS = new double[neuropil.length];
            for (int i=0; i<neuropil.length; i++)
                {
                finalSemN[i] = Math.sqrt(Math.pow(semN[i]/2.0d,2)+Math.pow(reference[i+5][0]/2.0d,2));    
                finalSemS[i] = Math.sqrt(Math.pow(semS[i]/3.0d,2)+Math.pow(semN[i]/3.0d,2)+Math.pow(reference[i+5][0]/3.0d,2));    
                }

            rt.incrementCounter();
            rt.addValue("Min", medianS[0]);    
            rt.addValue("Q1", medianS[1]);    
            rt.addValue("Med", medianS[2]);    
            rt.addValue("Q3", medianS[3]);    
            rt.addValue("Max", medianS[4]);    
            rt.incrementCounter();
            rt.addValue("Min", finalSemS[0]);    
            rt.addValue("Q1", finalSemS[1]);    
            rt.addValue("Med", finalSemS[2]);    
            rt.addValue("Q3", finalSemS[3]);    
            rt.addValue("Max", finalSemS[4]);    
            rt.incrementCounter();
            rt.addValue("Min", invMedS[0]);    
            rt.addValue("Q1", invMedS[1]);    
            rt.addValue("Med", invMedS[2]);    
            rt.addValue("Q3", invMedS[3]);    
            rt.addValue("Max", invMedS[4]);  
              
            rt2.incrementCounter();
            rt2.addValue("Min", medianN[0]);    
            rt2.addValue("Q1", medianN[1]);    
            rt2.addValue("Med", medianN[2]);    
            rt2.addValue("Q3", medianN[3]);    
            rt2.addValue("Max", medianN[4]);    
            rt2.incrementCounter();
            rt2.addValue("Min", finalSemN[0]);    
            rt2.addValue("Q1", finalSemN[1]);    
            rt2.addValue("Med", finalSemN[2]);    
            rt2.addValue("Q3", finalSemN[3]);    
            rt2.addValue("Max", finalSemN[4]);    
            rt2.incrementCounter();
            rt2.addValue("Min", invMedN[0]);    
            rt2.addValue("Q1", invMedN[1]);    
            rt2.addValue("Med", invMedN[2]);    
            rt2.addValue("Q3", invMedN[3]);    
            rt2.addValue("Max", invMedN[4]);    

            try
                {
                rt.saveAs(directory+"00 Statistics Summary "+refFiles[2]+" 3.xls");    
                rt2.saveAs(directory+"00 Statistics Summary "+refFiles[1]+" 3.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // create 2x 00 Statistics Summary [refFiles] 1-1.xls - Min,Q1,Median,Q3,Max. 1st line: Standard results, 2nd line: SEM/MADs
            rt.reset();
            rt2.reset();

            rt.incrementCounter();
            if (oldFormat)
                {
                rt.addValue("Min", invMedS[0]);    
                rt.addValue("Q1", invMedS[1]);    
                rt.addValue("Med", invMedS[2]);    
                rt.addValue("Q3", invMedS[3]);    
                rt.addValue("Max", invMedS[4]);    
                }
            else
                {
                rt.addValue("Min", medianS[0]);    
                rt.addValue("Q1", medianS[1]);    
                rt.addValue("Med", medianS[2]);    
                rt.addValue("Q3", medianS[3]);    
                rt.addValue("Max", medianS[4]);    
                }
            rt.incrementCounter();
            rt.addValue("Min", finalSemS[0]);    
            rt.addValue("Q1", finalSemS[1]);    
            rt.addValue("Med", finalSemS[2]);    
            rt.addValue("Q3", finalSemS[3]);    
            rt.addValue("Max", finalSemS[4]);    

            rt2.incrementCounter();
            if (oldFormat)
                {
                rt2.addValue("Min", invMedN[0]);    
                rt2.addValue("Q1", invMedN[1]);    
                rt2.addValue("Med", invMedN[2]);    
                rt2.addValue("Q3", invMedN[3]);    
                rt2.addValue("Max", invMedN[4]);    
                }
            else
                {
                rt2.addValue("Min", medianN[0]);    
                rt2.addValue("Q1", medianN[1]);    
                rt2.addValue("Med", medianN[2]);    
                rt2.addValue("Q3", medianN[3]);    
                rt2.addValue("Max", medianN[4]);    
                }
            rt2.incrementCounter();
            rt2.addValue("Min", finalSemN[0]);    
            rt2.addValue("Q1", finalSemN[1]);    
            rt2.addValue("Med", finalSemN[2]);    
            rt2.addValue("Q3", finalSemN[3]);    
            rt2.addValue("Max", finalSemN[4]);    

            try
                {
                rt.saveAs(directory+"00 Statistics Summary "+refFiles[2]+" 1-1.xls");    
                rt2.saveAs(directory+"00 Statistics Summary "+refFiles[1]+" 1-1.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // create 2x 00 Statistics Summary [refFiles] 2.xls - Value, SEM/MAD. 1st line: Quartile 1, 2nd line: Median, 3rd line: Quartile 3. 
            rt.reset();
            rt2.reset();
            for (int i=1; i<medianN.length-1; i++)
                {
                rt.incrementCounter();
                if (oldFormat) rt.addValue("Median", invMedS[i]);
                else rt.addValue("Median", medianS[i]);
                if (stats_mad) rt.addValue("MAD", finalSemS[i]);
                else rt.addValue("SEM", finalSemS[i]);

                rt2.incrementCounter();
                if (oldFormat) rt2.addValue("Median", invMedN[i]);    
                else rt2.addValue("Median", medianN[i]);    
                if (stats_mad) rt2.addValue("MAD", finalSemN[i]);
                else rt2.addValue("SEM", finalSemN[i]);
                }
            try
                {
                rt.saveAs(directory+"00 Statistics Summary "+refFiles[2]+" 2.xls");    
                rt2.saveAs(directory+"00 Statistics Summary "+refFiles[1]+" 2.xls");    
                }
            catch (IOException e) 
                {
                IJ.error(saveError); 
                return false;
                } 

            // create 2x 00 Statistics Summary [refFiles] 1-2 - 1-6.xls - Value, SEM/MAD
            if (sd) // if uncertainties should be calculated/plotted
                {            
                for (int i=0; i<medianN.length; i++)
                    {
                    rt.reset();
                    rt.incrementCounter();
                    if (oldFormat) rt.addValue("Median", invMedS[i]);    
                    else rt.addValue("Median", medianS[i]);    
                    if (stats_mad) rt.addValue("MAD", finalSemS[i]);
                    else rt.addValue("SEM", finalSemS[i]);
                        
                    rt2.reset();
                    rt2.incrementCounter();
                    if (oldFormat) rt2.addValue("Median", invMedN[i]);    
                    else rt2.addValue("Median", medianN[i]);    
                    if (stats_mad) rt2.addValue("MAD", finalSemN[i]);
                    else rt2.addValue("SEM", finalSemN[i]);

                    try
                        {
                        rt.saveAs(directory+"00 Statistics Summary "+refFiles[2]+" 1-"+(i+2)+".xls");    
                        rt2.saveAs(directory+"00 Statistics Summary "+refFiles[1]+" 1-"+(i+2)+".xls");    
                        }
                    catch (IOException e) 
                        {
                        IJ.error(saveError); 
                        return false;
                        } 
                    }
                }

            for (int i=2; i>0; i--) // generate GnuPlot scripts
                {
                // generate statscript1_refFiles[i].plt (box-whisker plot)    
                imagename = "00 Statistics "+refFiles[i]+" 1";
                filename = "statscript1_"+refFiles[i]+".plt";
                tp = initFile(); // initialize the gnuplot script
                if (plottitle!="") tp.append("set title \""+plottitle+"\"");
                tp.append("set xlabel \"\" ");
                tp.append("set ylabel \"ratio\" offset +2,0 tc rgb \"#062356\"");
                tp.append("set xrange [0:2]");
                tp.append("set yrange [0.00390625:256]");
                tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
                tp.append("set border 3 linestyle 10");
                tp.append("set ytics tc rgb \"#113577\" nomirror");
                tp.append("set logscale y 2");
                tp.append("set tics front out");
                tp.append("unset xtics");
                tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
                tp.append("set style fill solid 0.9 border");
                tp.append("set boxwidth 1.0");
                tp.append("set bars small");
    
                if (sd) // error bars
                    {
                    if (screen) // display on screen
                        {
                        tp.append("set term "+terminal+" title \"Ratios\"");
                        tp.append("set multiplot");
                        tp.append("set grid back ytics linestyle 11");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                        tp.append("unset grid");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("unset multiplot");
                        }
                    if (svg) // create .svg file
                        {
                        tp.append("set term svg dynamic enhanced");
                        tp.append("set output \""+imagename+".svg\"");
                        tp.append("set multiplot");
                        tp.append("set grid back ytics linestyle 11");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                        tp.append("unset grid");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("unset multiplot");
                        }
                    if (png) // create .png file
                        {
                        tp.append("set xlabel offset 0,0");
                        tp.append("set ylabel offset 0,0");
                        tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                        tp.append("set output \""+imagename+".png\"");
                        tp.append("set multiplot");
                        tp.append("set grid back ytics linestyle 11");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 6 lt 3 notitle");
                        tp.append("unset grid");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 6 lt 3 notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 6 lc rgb \"#1F497D\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-6.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-4.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-3.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-5.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 6 lc rgb \"#606060\" notitle");
                        tp.append("unset multiplot");
                        }
                    }
                else // no error bars
                    {
                    if (screen)
                        {
                        tp.append("set term "+terminal+" title \"Ratios\"");
                        tp.append("set multiplot");
                        tp.append("set grid back ytics linestyle 11");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 4 lt 3 notitle");
                        tp.append("unset grid");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 5 lc rgb \"#1F497D\" notitle");
                        tp.append("unset multiplot");
                        }
                    if (svg)
                        {
                        tp.append("set term svg dynamic enhanced");
                        tp.append("set output \""+imagename+".svg\"");
                        tp.append("set multiplot");
                        tp.append("set grid back ytics linestyle 11");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 4 lt 3 notitle");
                        tp.append("unset grid");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 5 lc rgb \"#1F497D\" notitle");
                        tp.append("unset multiplot");
                        }
                    if (png)
                        {
                        tp.append("set xlabel offset 0,0");
                        tp.append("set ylabel offset 0,0");
                        tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                        tp.append("set output \""+imagename+".png\"");
                        tp.append("set multiplot");
                        tp.append("set grid back ytics linestyle 11");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:2:6:5 with candlesticks whiskerbars 0.2 lc rgb \"#800080\" lw 4 lt 3 notitle");
                        tp.append("unset grid");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:3:3:5:5 with candlesticks lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                        tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 1-1.xls\' every ::1::1 using 1:4:4:4:4 with candlesticks lt -1 lw 5 lc rgb \"#1F497D\" notitle");
                        tp.append("unset multiplot");
                        }
                    }
    
                tp.append("#EOF");
                tp.saveAs(directory+filename); // end of statscript1   

                // generate statscript2_refFiles[i].plt (box plot)    
                imagename = "00 Statistics "+refFiles[i]+" 2";
                filename = "statscript2_"+refFiles[i]+".plt";
                tp = initFile(); // initialize the gnuplot script

                if (plottitle!="") tp.append("set title \""+plottitle+"\"");
                tp.append("set xlabel tc rgb \"#062356\"");
                tp.append("set ylabel \"ratio\" offset +2,0 tc rgb \"#062356\"");
                tp.append("set xrange [0:4]");
/*                double yLow = 0.5; // automatic generation of yrange
                double yHigh = 2.5;
                tp.append("set yrange ["+IJ.d2s(yLow,1)+":"+IJ.d2s(yHigh,1)+"]"); */
                tp.append("set yrange [0.00390625:256]");
                tp.append("set logscale y 2");
                tp.append("set style line 10 lt 0 lc rgb \"#808080\"");
                tp.append("set border 3 linestyle 10");
                tp.append("set xtics (\"\" 0, \"Quartile 1\" 1, \"Median\" 2, \"Quartile 3\" 3, \"\" 4) tc rgb \"#113577\" nomirror");
                tp.append("set ytics tc rgb \"#113577\" nomirror");
/*                String tics = IJ.d2s(yLow,1); // automatic generation of ytics
                long yMax = Math.round((yHigh-yLow)*10);
                for (long j=0; j<yMax; j++)
                    {
                    yLow = yLow + 0.1;
                    tics = tics+","+yLow;
                    }
                tp.append("set ytics ("+tics+") tc rgb \"#113577\" nomirror"); */
                tp.append("set tics front out");
                tp.append("set style line 11 lt 3 lc rgb \"#99bbf9\" lw 0.5");
                tp.append("set style fill solid 0.9 border");
                tp.append("set boxwidth 0.9");
                tp.append("set bars fullwidth");
    
                if (screen)
                    {
                    tp.append("set term "+terminal+" title \"Ratios\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::1::1 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::2::2 with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::3::3 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                    tp.append("unset multiplot");
                    }
                if (svg)
                    {
                    tp.append("set term svg dynamic enhanced");
                    tp.append("set output \""+imagename+".svg\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::1::1 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::2::2 with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::3::3 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                    tp.append("unset multiplot");
                    }
                if (png)
                    {
                    tp.append("set xlabel offset 0,0");
                    tp.append("set ylabel offset 0,0");
                    tp.append("set term png font \"/Library/Fonts/Tahoma.ttf\" 14 size 2048,1536");
                    tp.append("set output \""+imagename+".png\"");
                    tp.append("set multiplot");
                    tp.append("set grid back ytics linestyle 11");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::1::1 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("unset grid");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::2::2 with boxes lc rgb \"#164191\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2 every ::3::3 with boxes lc rgb \"#9BBB59\" lw 4 lt 3 notitle");
                    tp.append("plot \'00 Statistics Summary "+refFiles[i]+" 2.xls\' using 1:2:3 with errorbars pointtype 0 lt -1 lw 8 lc rgb \"#808080\" notitle");
                    tp.append("unset multiplot");
                    }
                tp.append("#EOF");
                tp.saveAs(directory+filename); // end of statscript2                   
                } // end of generation of GnuPlot scripts (for-loop)
            } // end of job 5, normalized statistics
            
        return true; // all jobs successful
        } // end of createFile()


    private int[][] loadHistoFiles() // read the data from histogram files
        { 
        Vector<StringTokenizer> list = new Vector<StringTokenizer>(0, 16); // content of each file 
        String inputname = "";
        int n = 0;
        String part = "";

        inputname = "01 Histogram.xls";
        list = readFile(inputname); // test whether files can be read           
        if (list==null) return null;
        if (list.size()==0) return null; 
        n = list.size()-1; // determine file size (number of bins)
        int[][] data = new int[n][nFiles]; // final data (returned)

        for (int k=1;k<=nFiles;k++) // cycle through all files
            {
            if (k<10) inputname = "0"+k+" Histogram.xls";
            else inputname = k+" Histogram.xls";          
            list = readFile(inputname); // read data           
            if (list.size()==0) return null; 
            n = list.size()-1; 
            StringTokenizer st;
    
            try
                {
                st = (StringTokenizer)list.elementAt(1); // test whether there is any data in the file 
                }
            catch (ArrayIndexOutOfBoundsException e)
                {
                IJ.error("File \""+directory+inputname+"\" is too short.");
                return null; 
                }
                
            for (int i = 0; i < n; i++) // cycle through all bins
                { 
                st = (StringTokenizer)list.elementAt(i+1); 
                part = st.nextToken(); // skip the index (line numbers)
                part = st.nextToken(); 
                try 
                    { 
                    data[i][k-1] = Integer.valueOf(part).intValue(); // read data
                    } 
                catch (NumberFormatException e) 
                    { 
                    IJ.error("Unknown file format: \""+directory+inputname+"\"");
                    return null; 
                    } 
                } // bin read 
            } // all files read

        return data; 
        } // end of loadHistoFiles()


    private Vector<StringTokenizer> readFile(String inputname) // loads a file for loadHistoFiles() and loadStatFiles()
        {    
        Vector<StringTokenizer> list = new Vector<StringTokenizer>(0, 16); 
        String line = ""; 

        try 
            { 
            FileReader fr = new FileReader(directory+inputname); 
            BufferedReader br = new BufferedReader(fr); 

            do 
                { 
                line = br.readLine(); 
                if (line != null)
                    { 
                    StringTokenizer st = new StringTokenizer(line); 
                    if(st.hasMoreTokens()) list.addElement(st); 
                    } 
                } 
            while (line != null); 

            fr.close(); 
            } 
        catch (FileNotFoundException e) 
            {
            IJ.error("File \""+directory+inputname+"\" not found."); 
            return null; 
            }
        catch (IOException e) 
            {
            IJ.error("Couldn't read from file \""+directory+inputname+"\"."); 
            return null; 
            } 
        return list;
        } // end of readFile()


    private static double getMean(int[] data) // used for calculating the mean histogram, calculates the average of a bin 
        {
		int n = data.length;
		double sum=0.0d;
		for (int i=0; i<n; i++) 
		  {
		  sum += data[i];
		  }
		double result = sum/n;
		return result;
        }


    private static double getSD(int[] data, double mean) // used for calculating the standard deviation of a mean histogram bin 
        {
		int n = data.length;
		double sum=0.0d;
		for (int i=0; i<n; i++) 
		  {
		  sum += (data[i]-mean)*(data[i]-mean);
		  }
		double stdDev = Math.sqrt(sum/(n-1));
		return stdDev;
        }


     private static int getMedian(int[] matrix) // Get median value of a matrix. The input matrix already has to be sorted. Used for calculating histogram in createFile().
        {
        int medPos = (matrix.length+1)/2;
        int median = 0;
        
        if (matrix.length % 2 == 1) // odd size
            {
            median = matrix[(int)medPos-1];
            }   
        else // even size
            {
            int bM = (int)Math.round(medPos-1.5);
            int aM = (int)Math.round(medPos-0.5);
            int vbm = matrix[bM];
            int vam = matrix[aM];
            median = (int)Math.round((vbm+vam)/2.0d);
            }   
        return median;        
        }


     private static double getMedian(double[] matrix) // Get median value of a matrix. The input matrix already has to be sorted. Used for calculating statistics in createFile().
        {
        double medPos = (matrix.length+1)/2;
        double median = 0;
        
        if (matrix.length % 2 == 1) // odd size
            {
            median = matrix[(int)medPos-1];
            }   
        else // even size
            {
            int bM = (int)Math.round(medPos-1.5);
            int aM = (int)Math.round(medPos-0.5);
            double vbm = matrix[bM];
            double vam = matrix[aM];
            median = (vbm+vam)/2.0d;
            }   
        return median;        
        }


    private static double getSEMed(int[] data) // get standard error of the median. Used for calculating histogram in createFile().
        {
        // standard error of the median according to: Lothar Sachs, Angewandte Statistik, 11. Auflage 2003, S. 160. s = (a-b) / 3.4641; a = (n/2 + sqrt(3n)/n) th observation, b = (n/2 - sqrt(3n)/n) th observation, rounded up to the next number. 
        double a = (data.length/2.0d + Math.sqrt(3.0d*data.length)/data.length);
        double b = (data.length/2.0d - Math.sqrt(3.0d*data.length)/data.length);
        double sem = Math.abs((data[(int)Math.ceil(a)] - data[(int)Math.ceil(b)]) / 3.4641d);
		return sem;
        }


    private static double getSEMed(double[] data)  // get standard error of the median. Used for calculating statistics in createFile().
        {
        // standard error of the median according to: Lothar Sachs, Angewandte Statistik, 11. Auflage 2003, S. 160. s = (a-b) / 3.4641; a = (n/2 + sqrt(3n)/n) th observation, b = (n/2 - sqrt(3n)/n) th observation, rounded up to the next number. 
        double a = (data.length/2.0d + Math.sqrt(3.0d*data.length)/data.length);
        double b = (data.length/2.0d - Math.sqrt(3.0d*data.length)/data.length);
        double sem = 0.0;
        if (oldFormat) sem = Math.abs((1.0d/(2-data[(int)Math.ceil(a)]) - 1.0d/(2-data[(int)Math.ceil(b)])) / 3.4641d);
        else sem = Math.abs((data[(int)Math.ceil(a)] - data[(int)Math.ceil(b)]) / 3.4641d);
		return sem;
        }


    private void plotLine(TextPanel tp) // generates the plot command for the histogram GnuPlot script
        {
        if (nFiles==1) tp.append("plot \'01 Histogram.xls\' using 1:2 notitle with boxes lc rgb \"#164191\"");
        else
            {
            String tempS1 = "";
            String tempS2 = "$2";
            int c=2;
            for (int i=1;i<=nFiles;i++)
                {
                if (i<10) tempS1 = tempS1+" \'0"+i+" Histogram.xls\'";
                else tempS1 = tempS1+" \'"+i+" Histogram.xls\'";
                if (i>1) tempS2 = tempS2+"+$"+c;
                c=c+2;
                }
            tp.append("plot \"< paste"+tempS1+"\" using 1:(("+tempS2+")/"+((c-2)/2)+") notitle with boxes lc rgb \"#164191\"");
            }
        }


    private double[][] loadStatFiles(int lines, int columns, boolean inverse, String addName, boolean extractMed) // extract data from statistics files
    // read LINES line per file, COLUMNS columns per file, INVERSE=false: output data = [data][files], ADDNAME: add a string to the input name, EXTRACTMED: get just the median and not all data (currently not used)
        { 
        Vector<StringTokenizer> list = new Vector<StringTokenizer>(0, 16); // content of each file
        String inputname = "";
        int n = 0;
        int nd = columns;
        String part = "";
        double[][] data = new double[nFiles][nd*lines]; // final data (returned)     
        if (!inverse) data = new double[nd*lines][nFiles];
        int c = 0; // counter for the position within data[][]
        StringTokenizer st;
        
        for (int k=1;k<=nFiles;k++) // cycle through files
            {
            if (chName) inputname = refFiles[0]; // only needed for normalized statistics. Used when reading data from the reference file
            else if (k<10) inputname = "0"+k+" Statistics"+addName+".xls";
            else inputname = k+" Statistics"+addName+".xls";          
            list = readFile(inputname); // read the file
            if (list==null) return null;           
            if (list.size()==0) return null; 
            n = list.size()-1; // lines in the file
            if (extractMed && (k==1)) // read only the median or first file
                {
                lines = n;
                data = new double[nFiles][nd*lines]; // re-initialize data[][]     
                if (!inverse) data = new double[nd*lines][nFiles];
                }
    
            try
                {
                st = (StringTokenizer)list.elementAt(1); // test whether there is any data in the file
                nd = st.countTokens();                
                }
            catch (ArrayIndexOutOfBoundsException e)
                {
                IJ.error("File \""+directory+inputname+"\" is too short.");
                return null; 
                }
                
            for (int i = 0; i < lines; i++) // read all the lines
                { 
                st = (StringTokenizer)list.elementAt(i+1); 
                part = st.nextToken(); // skip the index (line numbers)
                if (extractMed) // skip MIN and Q1
                    {
                    part = st.nextToken(); 
                    part = st.nextToken(); 
                    nd = 2;
                    }
                for (int j = 0; j < nd-1; j++) // cycle through the columns
                    { 
                    part = st.nextToken(); // get the first column to read
                    try 
                        { 
                        if (inverse) data[k-1][c] = Double.valueOf(part).doubleValue(); 
                        else data[c][k-1] = Double.valueOf(part).doubleValue(); 
                        } 
                    catch (NumberFormatException e) 
                        { 
                        IJ.error("Unknown file format: \""+directory+inputname+"\"");
                        return null; 
                        } 
                    c++; // necessary for the position within data[][]
                    } // line finished 
                } // file finished
            c=0;
            } // all data read

        return data; 
        } // end of loadStatFiles()


    private ArrayList<ArrayList<Double>> loadStatList(String addName) // read data for statTest() (comparative statistics). Based on loadStatFiles() but returns an ArrayList instead of an array. Reads only the median.
        { 
        Vector<StringTokenizer> list = new Vector<StringTokenizer>(0, 16); 
        String inputname = "";
        int n = 0, lines = 0, nd = 2;
        String part = "";

        ArrayList<ArrayList<Double>> data = new ArrayList<ArrayList<Double>>(nFiles); // final data (returned)
        ArrayList<Double> dList = new ArrayList<Double>(); // data from one file  
        StringTokenizer st;
        
        for (int k=1;k<=nFiles;k++) // cycle through files
            {
            if (k<10) inputname = "0"+k+" Statistics"+addName+".xls";
            else inputname = k+" Statistics"+addName+".xls";          
            list = readFile(inputname);            
            if (list==null) return null;           
            if (list.size()==0) return null; 
            n = list.size()-1; 
            lines = n;
            dList = new ArrayList<Double>(nd*lines); // contains the data from one file
    
            try
                {
                st = (StringTokenizer)list.elementAt(1); // test whether there is any data in the file 
                nd = st.countTokens();                
                }
            catch (ArrayIndexOutOfBoundsException e)
                {
                IJ.error("File \""+directory+inputname+"\" is too short.");
                return null; 
                }
                
            for (int i = 0; i < lines; i++) // read all lines
                { 
                st = (StringTokenizer)list.elementAt(i+1); 
                part = st.nextToken(); // read only the median; skip index, MIN and Q1
                part = st.nextToken(); 
                part = st.nextToken(); 
                nd = 2;
                for (int j = 0; j < nd-1; j++) // cycle through columns
                    { 
                    part = st.nextToken(); // get the data to read
                    try 
                        { 
                        dList.add(Double.valueOf(part).doubleValue());
                        } 
                    catch (NumberFormatException e) 
                        { 
                        IJ.error("Unknown file format: \""+directory+inputname+"\"");
                        return null; 
                        } 
                    } 
                } 
            data.add(dList); // add file to list
            }

        return data; 
        } // end of loadStatList()


    public ImagePlus averagePlots(ImagePlus[] imp_in) // average scatter plots; imp_in contains all the scatter plots
        {
        ImageProcessor[] ip = new ImageProcessor[imp_in.length];
        int width  = imp_in[0].getWidth(); 
        int height = imp_in[0].getHeight();
        int size = width*height;       

        String imp_out_title = "Average scatter plot"; // create a title for the output image
        ImagePlus imp_out = NewImage.createFloatImage(imp_out_title, width, height, 1, 1);
        if (imp_out == null) // produce an error if this fails
            {
            IJ.error(title, "Oops, out of memory...");
            return null;
            }
        WindowManager.checkForDuplicateName = true; // add a number to the title if name already exists  
        float[][] pixels_in = new float[imp_in.length][size]; // will contain all input data

        for (int i=0; i<imp_in.length; i++) // cycle through all scatter plots and read the data
            {
            ip[i] = imp_in[i].getProcessor();               
            pixels_in[i] = (float[])ip[i].getPixels();                
            }

        // do the averaging
        double[] pixels_out = new double[size];
        double value, sum, newPixel; // value = final value per position, sum = sum of pixel values, newPixel = new pixel value
        for (int i=0; i<size; i++) 
            {
            sum = 0.0d;
            for (int j=0; j<imp_in.length; j++) // sum up all frequencies at each pixel/position 
                {
                newPixel = (double)pixels_in[j][i]; // get new data
                sum += newPixel; // add it
                }
            value = sum/imp_in.length; // calculate the average
            pixels_out[i] = value;
            }
        
        // generate the output image
        ImageProcessor ip_out = new FloatProcessor(width, height, pixels_out); // create the output image
		ip_out.setColorModel(ip[0].getCurrentColorModel()); // apply the LUT
        ImageStatistics iSt = new ImageStatistics(); // find the max value
        iSt = ImageStatistics.getStatistics(ip_out, 16, null); // Get raw MIN_MAX
        ip_out.setMinAndMax(0,iSt.max); // scale the LUT
        imp_out.setProcessor(null, ip_out);
        imp_out.copyScale(imp_in[0]);
        WindowManager.setTempCurrentImage(imp_out); 
        IJ.run("Fire"); // change the lookup table

        return imp_out;
        } // end of averagePlots() (scatter)


    public boolean statTest(ArrayList<ArrayList<Double>> dList) // Mann-Whitney U-test on statistics of all files. Done using the jsc.jar library from A.J. Bertie,  http://www.jsc.nildram.co.uk/
        {
        int t1 = 1, t2 = 1; // counter (test file 1 and test file 2)
        int fileCounter = 0, nTests = 0; // counter
        MannWhitneyTest mwt;

        // the use of ArrayLists is necessary because the different files can contain different amounts of samples
        ArrayList<double[]> data = new ArrayList<double[]>(nFiles); // will contain the data
        ArrayList<Double> tempList; // ArrayList for each file
        double[] tempData; // array for each file

        String filename = "00 Statistics Summary 4.txt"; // output file
        TextPanel tp = new TextPanel(); // content of output file

        // read files from ArrayList dList and add them as double[] arrays into the ArrayList data
        for (int i=0; i<nFiles; i++) // cycle through files
            {
            tempList = (ArrayList<Double>)dList.get(i); // load file into ArrayList
            tempData = new double[tempList.size()]; // create an array for the file
            for (int j=0; j<tempData.length; j++)
                {
                tempData[j] = (double)tempList.get(j);
                }
            data.add(tempData); // add to final ArrayList
            }

        // do the tests
        for (int i=0; i<nFiles; i++) // compare all files with each other
            {
            fileCounter++;
            for (int j=0; j<(nFiles-fileCounter); j++)
                {
                nTests++; // counts all tests
                t2++;
                tp.append("Mann-Whitney U-test of "+xTitle[t1-1]+" ("+IJ.d2s(t1,0)+") vs "+xTitle[t2-1]+" ("+IJ.d2s(t2,0)+"):");
                mwt = new MannWhitneyTest((double[])data.get(t1-1),(double[])data.get(t2-1)); // MWU test of two files
                tp.append("Two-tailed exact p value: "+IJ.d2s(mwt.exactSP(),9));
                tp.append("U statistic: "+IJ.d2s(mwt.getStatistic(),0));
                tp.append("Z (normality): "+IJ.d2s(mwt.getZ(),9)+" (significant if |Z| >= 1.96 and sample size >= 20)");
                tempData = (double[])data.get(t1-1);
                tp.append("Sum of ranks 1: "+IJ.d2s(mwt.getRankSumA(),0)+", sample size: "+IJ.d2s(tempData.length,0));
                tempData = (double[])data.get(t2-1);
                tp.append("Sum of ranks 2: "+IJ.d2s(mwt.getRankSumB(),0)+", sample size: "+IJ.d2s(tempData.length,0));
                tp.append("");
                }
            t1++;
            t2=t1;
            }
        // Bonferroni correction
        double alpha = 0.05d;
        double bon = alpha/nTests;
        tp.append("Bonferroni's adjustment to alpha ("+alpha+"): "+IJ.d2s(nTests,0)+" test(s) -> "+IJ.d2s(bon,9));
        tp.saveAs(directory+filename); // save file   

        return true;
        } // end of statTest()

        
    private boolean fileDialog() // ask the user what to do
        {
        String[] purpose_temp = new String[7]; // which analyses to run
        purpose_temp[0] = "Histograms";
        purpose_temp[1] = "Statistics";
        purpose_temp[2] = "Scatter";
        purpose_temp[3] = "All basic plots";
        purpose_temp[4] = "Comparative statistics";
        purpose_temp[5] = "Normalized statistics (disabled)";
        purpose_temp[6] = "Only histogram overview";

        String[] terminalC = new String[4]; // terminal for GnuPlot
        terminalC[0] = "aqua";
        terminalC[1] = "x11";
        terminalC[2] = "windows";
        terminalC[3] = "wxt";

        // create the dialog
        GenericDialog gd = new GenericDialog(title);
        gd.addChoice("What do you want to plot:", purpose_temp, purpose_temp[job]);
        gd.addNumericField("Number of input files:", nFiles, 0);
//        gd.addNumericField("Arrange comparative statistics in groups of:", 3, 0); // DISABLED
        gd.addCheckbox("Calculate Standard Errors", sd);       
        gd.addCheckbox("Use Median Absolute Deviation instead of Standard Error of the Median for Statistics", stats_mad);              
        gd.addCheckbox("Use Mean instead of Median for Statistics", statsMean);              
        gd.addCheckbox("Use Median instead of Mean for Histograms", histo_med);              
		gd.setInsets(0,20,20);
        gd.addCheckbox("Use statistics files in the old format", oldFormat);              
        gd.addStringField("Title of plot:", plottitle, 30);
        gd.addStringField("X axis label:", axislabel, 30);
		gd.setInsets(20,20,0);
        gd.addCheckbox("Enter directory for saving files manually", false);
        gd.addStringField("Directory:", directory, 30);
		gd.setInsets(20,20,0);
        gd.addCheckbox("Display results on screen", screen);
		gd.setInsets(0,20,0);
        gd.addChoice("Which terminal do you want to use for display:", terminalC, terminal);
		gd.setInsets(0,20,20);
        gd.addMessage("\'aqua\' is recommended for OS X, \'windows\' for Windows");
        gd.addCheckbox("Create .svg file", svg);
        gd.addCheckbox("Create .png file", png);
		gd.setInsets(20,20,0);
        gd.addMessage("Files to be processed by the script need to follow this pattern:");
		gd.setInsets(0,20,0);
        gd.addMessage("\"01 Filename.xls\", \"02 Filename.xls\" etc.");
        gd.showDialog();
        if (gd.wasCanceled())  return false;
        
        job = gd.getNextChoiceIndex();
        int termID = gd.getNextChoiceIndex();
        nFiles = (int)gd.getNextNumber();
        if (nFiles == 0) return false;
//        compGroups = (int)gd.getNextNumber();
        sd = gd.getNextBoolean();
        stats_mad = gd.getNextBoolean();
        statsMean = gd.getNextBoolean();
        histo_med = gd.getNextBoolean();
        oldFormat = gd.getNextBoolean();
        boolean manual = gd.getNextBoolean();
        screen = gd.getNextBoolean();
        svg = gd.getNextBoolean();
        png = gd.getNextBoolean();
        plottitle = gd.getNextString();
        axislabel = gd.getNextString();
        String dirtemp = gd.getNextString();

        if (job==5)
            {
            IJ.error("Normalized statistics have been disabled.");
            return false;
            }
        
        switch (termID) // get the gnuplot terminal
            {
            case 0: terminal = terminalC[0];   
                    break;
            case 1: terminal = terminalC[1];   
                    break;
            case 2: terminal = terminalC[2];   
                    break;
            case 3: terminal = terminalC[3];   
                    break;
            }
  
        if(!manual)
            {
            DirectoryChooser sd = new DirectoryChooser("Where do you want to save your file?");
            directory = sd.getDirectory();
            if (directory==null) return false;
            }
        else
            {
            directory = dirtemp;
            }

        if (job==3) all=true; // run all basic analyses     
        
        if (job==0 || job==1 || job==3 || job==5) // if histogram or statistics shall be calculated
            {
            if (nFiles<4 && (!stats_mad || histo_med))
                {
                IJ.showMessage("Standard error of the median can only be calculated with data from at least 4 files; switching to means (histogram) and MAD (statistics) instead.");
                stats_mad = true;
                histo_med = false;
                }     
            }

        if (job==4) // comparative statistics
            { // show another dialog for the x-labels
            if (nFiles<2) return false;
            String[] field_temp = new String[nFiles];
            field_temp[0] = "BRP-NT"; // create the text fields for the x-labels
            field_temp[1] = "RBP-CT";
            if (nFiles>2) field_temp[2] = "Syd-1";
            if (nFiles>3)
                {
                for (int i=3; i<nFiles; i++)
                    {
                    field_temp[i] = "";
                    }                   
                }
            
            gd = new GenericDialog(title);
            gd.addMessage("Choose x-labels:");
            for (int i=1; i<=nFiles; i++)
                {
                gd.addStringField("File "+i+":", field_temp[i-1], 30);
                }

            gd.showDialog();
            if (gd.wasCanceled())  return false;

            xTitle = new String[nFiles]; // get the x-labels
            for (int i=0; i<nFiles; i++)
                {
                xTitle[i] = gd.getNextString();
                }
            }

        if (job==5) // normalized statistics
            {
            gd = new GenericDialog(title); // get the necessary input files
            gd.addMessage("Files and Subdirectories:");
            gd.addStringField("Control file:", "control.xls", 30);
            gd.addStringField("Neuropil:", "calyx", 30);
            gd.addStringField("To be normalized:", "gfp", 30);

            gd.showDialog();
            if (gd.wasCanceled())  return false;

            refFiles = new String[3];
            refFiles[0] = gd.getNextString();
            refFiles[1] = gd.getNextString();
            refFiles[2] = gd.getNextString();
            }

        if (job==6) // only create histogram overview
            {
            job = 0;
            overview = true;
            }

        return true;
        } // end of fileDialog()
    } 